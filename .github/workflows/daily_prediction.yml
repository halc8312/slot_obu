# 権限修正版のワークフロー
# .github/workflows/daily_prediction.yml

name: Daily Pachislot Prediction

on:
  schedule:
    # 日本時間 毎朝6:00 (UTC 21:00)
    - cron: '0 21 * * *'
  workflow_dispatch:  # 手動実行も可能

# 権限を明示的に設定
permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  predict:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.9'
    
    - name: Cache pip packages
      uses: actions/cache@v4
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('requirements.txt') }}
    
    - name: Install dependencies
      run: |
        pip install torch --index-url https://download.pytorch.org/whl/cpu
        pip install pandas numpy scikit-learn beautifulsoup4 requests joblib
    
    - name: Download model from releases
      run: |
        # モデルとスケーラーをGitHub Releasesから取得
        wget https://github.com/halc8312/slot_obu/releases/download/quantile-model-v1/quantile_loss_model.pth || echo "Model not found"
        wget https://github.com/halc8312/slot_obu/releases/download/quantile-model-v1/quantile_feature_scaler.joblib || echo "Scaler not found"
        wget https://github.com/halc8312/slot_obu/releases/download/quantile-model-v1/quantile_model_params.joblib || echo "Model params not found"
        # データファイル（オプション）
        wget https://github.com/halc8312/slot_obu/releases/download/quantile-model-v1/final_integrated_13months_data.csv || echo "Data file not found"
        # 機種マスターデータ
        mkdir -p data
        wget -O data/machine_master.csv https://github.com/halc8312/slot_obu/releases/download/quantile-model-v1/machine_master.csv || echo "Machine master not found"
        
        # ダウンロード確認
        echo "=== Downloaded files ==="
        ls -la *.pth *.joblib *.csv 2>/dev/null || echo "No model files in root"
        echo "=== Data directory ==="
        ls -la data/ 2>/dev/null || echo "No data directory"
    
    - name: Collect daily data
      run: python scripts/daily_data_collector.py
    
    - name: Run prediction
      run: |
        # 通常の明日の予測
        python scripts/daily_predictor.py
        
        # 明日が「1の付く日」の場合は特別な通知
        TOMORROW=$(date -d tomorrow +%d)
        if [[ "$TOMORROW" == "01" || "$TOMORROW" == "11" || "$TOMORROW" == "21" || "$TOMORROW" == "31" ]]; then
          echo "::notice title=特別日::明日は「1の付く日」です！高出率が期待できます。"
        fi
    
    - name: Generate report
      run: python scripts/report_generator.py
    
    - name: Deploy to GitHub Pages
      uses: peaceiris/actions-gh-pages@v4
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        publish_dir: ./reports
        
    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: prediction-results
        path: |
          reports/*.html
          data/*.csv
        retention-days: 30